{% extends "base.html.jinja" %}

{% block content %}
<div class="w-2/3 mx-auto items-center justify-center p-2 mt-2">
  <div class="text-center text-3xl text-blue-600">
    你好！我是AI分身，我叫Q，你有问题都可以问我！
  </div>
  <div x-data="{}" class="border-2 border-amber-600">
    <button
      calss="w-18 h-18 bg-blue-300 px-2 bg-red-500 m-10 rounded-lg"
      @keyup.space.window="recordingState"
    >
      按下空格开始接听
    </button>
    <i class="fa-regular fa-microphone-lines"></i>
  </div>

  <ul hx-ext="sse" sse-connect="/chats" sse-swap="message" hx-swap="beforeend"
    class="mt-4 p-2 rounded border flex items-center justify-center">
  </ul>

  <div class="space-y-8"/>

  {# 单向数据: hx-ext="sse" sse-connect="/signals" sse-swap="message" #}
  <div hx-ext="sse" sse-connect="/signals" sse-swap="message" class="p-2 flex items-center justify-center text-center">
    status
  </div>
</div>
{% endblock content %}

{% block script %}
<script>
  let recorder
  let isRecording = false

  function recordingState() {
    if (isRecording) {
      console.log('recordingState stop')
      recorder.stop();
    } else {
      console.log('recordingState start')
      recorder.start();
    }

    isRecording = !isRecording;
  }

  document.addEventListener("DOMContentLoaded", function () {
    console.log('initialization')
    recorder = new Recorder();
    recorder.init();
  });

  function startRecording() {
    console.log('startRecording')
    recorder.start()
  }

  class Recorder {
    mediaRecorder;
    recordedChunks = [];

    async init() {
      console.log("the init of Recorder");

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        this.mediaRecorder = new MediaRecorder(stream);

        this.mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            this.recordedChunks.push(event.data);
          }
        };

        this.mediaRecorder.onstop = async() => {
          const audioBlob = new Blob(this.recordedChunks, { type: 'audio/mp3' });

          const formData = new FormData();
          formData.append('audio', audioBlob);

          fetch(
            '/assistant',
            { method: 'POST',  body: formData }
          ).then(async (res)=>{
            let data = await res.json();
            console.log("> res:", data);
          });
        };
      } catch (error) {
        console.error('Error accessing microphone:', error.message);
      }
    }

    start() {
      this.recordedChunks = [];
      this.mediaRecorder.start();
    }

    stop() {
      this.mediaRecorder.stop();
    }
  }
</script>
{% endblock %}
